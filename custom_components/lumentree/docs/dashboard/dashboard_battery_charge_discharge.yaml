type: custom:apexcharts-card
header:
  title: Battery Charge & Discharge
  show: true
graph_span: 24h
span:
  start: day
now:
  show: false
apex_config:
  chart:
    type: area
    height: 300
    toolbar:
      show: true
      tools:
        download: true
        selection: true
        zoom: true
        zoomin: true
        zoomout: true
        pan: true
        reset: true
  xaxis:
    type: datetime
    labels:
      format: HH:mm
      rotate: -45
  yaxis:
    - title:
        text: Power (W)
        style:
          fontSize: '12px'
  legend:
    position: top
    horizontalAlign: right
    fontSize: '12px'
    formatter: |
      EVAL:function(seriesName, opts) {
        return seriesName;
      }
  tooltip:
    shared: true
    intersect: false
    y:
      formatter: |
        EVAL:function(val) {
          return Math.abs(val) + ' W';
        }
  fill:
    opacity: 0.3
card_mod:
  style: |
    ha-card {
      background: var(--card-background-color);
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
series:
      - entity: sensor.device_YOUR_DEVICE_ID_charge_today
    name: Charge
    type: area
    color: "#4CAF50"
    stroke_width: 2
    data_generator: |
      return (function() {
        const attr = entity.attributes.series_5min_w || [];
        const arr = typeof attr === 'string' ? attr.split(',').map(function(x) { return parseFloat(x.trim()) || 0; }) : attr;
        const now = new Date();
        const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);

        return arr.map(function(value, index) {
          const hours = Math.floor(index / 12);
          const minutes = (index % 12) * 5;
          const timestamp = new Date(startOfDay);
          timestamp.setHours(hours, minutes, 0, 0);
          const val = parseFloat(value) || 0;
          return [timestamp.getTime(), Math.min(Math.max(val, 0), 4000)];
        });
      })();
  
      - entity: sensor.device_YOUR_DEVICE_ID_discharge_today
    name: Discharge
    type: area
    color: "#FF9800"
    stroke_width: 2
    data_generator: |
      return (function() {
        const attr = entity.attributes.series_5min_w || [];
        const arr = typeof attr === 'string' ? attr.split(',').map(function(x) { return parseFloat(x.trim()) || 0; }) : attr;
        const now = new Date();
        const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);

        return arr.map(function(value, index) {
          const hours = Math.floor(index / 12);
          const minutes = (index % 12) * 5;
          const timestamp = new Date(startOfDay);
          timestamp.setHours(hours, minutes, 0, 0);
          const val = parseFloat(value) || 0;
          return [timestamp.getTime(), -Math.min(Math.max(val, 0), 3000)];
        });
      })();
